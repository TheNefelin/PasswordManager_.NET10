<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:PasswordManager_.NET10.Behaviors.PasswordDetails"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="PasswordManager_.NET10.Views.Main.PasswordDetailsPage"
             x:Name="thisPage"
             Title="Password Details">

    <!-- Grid principal con menÃº lateral -->
    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*">

        <!-- Header con bÃºsqueda y menÃº -->
        <Grid Grid.Row="0"
              ColumnDefinitions="50,*,50" 
              Padding="10"
              BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1E1E1E}">

            <!-- BotÃ³n MenÃº Hamburguesa -->
            <Button Grid.Column="0"
                    Text="â˜°"
                    FontSize="24"
                    BackgroundColor="Transparent"
                    Command="{Binding ToggleMenuCommand}"/>

            <!-- Barra de bÃºsqueda -->
            <SearchBar Grid.Column="1"
                       Placeholder="Buscar contraseÃ±a..."
                       Text="{Binding SearchText}"/>

            <!-- BotÃ³n Ordenar/Filtrar -->
            <Button Grid.Column="2"
                    Text="âš™ï¸"
                    FontSize="20"
                    BackgroundColor="Transparent"
                    Command="{Binding DownloadPasswordsCommand}"/>

        </Grid>

        <!-- Contenido principal (Lista/Loading/Empty) -->
        <Grid Grid.Row="1" RowDefinitions="*">

            <CollectionView ItemsSource="{Binding DisplayedPasswordItems}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>

                        <toolkit:Expander
                            IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                            Margin="0,0,0,5">

                            <toolkit:Expander.Header>
                                <Grid ColumnDefinitions="50,*,50"
                                    Padding="15"
                                    BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2E2E2E}">

                                    <Label Grid.Column="0" Text="ðŸ”" FontSize="24"/>
                                    <Label Grid.Column="1" Text="{Binding Data01}" FontSize="16" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="â–¼" FontSize="16"/>
                                </Grid>
                            </toolkit:Expander.Header>

                            <toolkit:Expander.Content>
                                <StackLayout Padding="5">
                                    <Grid ColumnDefinitions="auto,*" RowDefinitions="auto, auto" ColumnSpacing="15" RowSpacing="5" Margin="20">
                                        <Label Grid.Column="0" Grid.Row="0" FontAttributes="Bold" Text="Usuario:" />
                                        <Label Grid.Column="1" Grid.Row="0" Text="{Binding Data02}"/>

                                        <Label Grid.Column="0" Grid.Row="1" FontAttributes="Bold" Text="ContraseÃ±a:" VerticalOptions="Center"/>
                                        <!--<Label Grid.Column="1" Grid.Row="1" Text="{Binding Data03}" />-->
                                        <Entry Grid.Column="1" Grid.Row="1" IsReadOnly="True" Text="{Binding Data03}" IsPassword="{Binding Source={x:Reference thisPage}, Path=BindingContext.IsPassword}"/>
                                    </Grid>

                                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="10" Margin="5">
                                        <Button 
                                            Command="{Binding Source={x:Reference thisPage}, Path=BindingContext.ToggleIsPasswordCommand}"
                                            Text="Ver"
                                            ImageSource="icon_eye_lock_open_512.png"
                                            HeightRequest="50" />
                                        
                                        <Button
                                            Command="{Binding Source={x:Reference thisPage}, Path=BindingContext.EditPasswordCommand}"
                                            CommandParameter="{Binding .}"
                                            Text="Editar" 
                                            HeightRequest="50" 
                                            ImageSource="icon_edit_512.png" />

                                        <Button 
                                            Command="{Binding Source={x:Reference thisPage}, Path=BindingContext.DeletePasswordCommand}"
                                            CommandParameter="{Binding .}"
                                            Text="Eliminar" 
                                            HeightRequest="50" 
                                            ImageSource="icon_delete_512.png" />
                                    </HorizontalStackLayout>
                                </StackLayout>
                            </toolkit:Expander.Content>
                        </toolkit:Expander>

                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            
            <!-- Loading Indicator -->
            <ActivityIndicator Grid.Row="0"
                             IsRunning="{Binding IsLoading}"
                             IsVisible="{Binding IsLoading}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"/>
        </Grid>

        <!-- MenÃº lateral (oculto por defecto) -->
        <Border Grid.Row="0"
               Grid.RowSpan="2"
               x:Name="SideMenu"
               IsVisible="{Binding IsMenuOpen}"
               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2E2E2E}"
               Padding="0"
               HorizontalOptions="Start"
               WidthRequest="280"
               ZIndex="100">

            <Border.Behaviors>
                <local:MenuAnimationBehavior/>
            </Border.Behaviors>

            <VerticalStackLayout Spacing="0">

                <!-- Header del menÃº -->
                <Grid Padding="20"
                      BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#1A1A1A}">
                    <Label Text="Opciones"
                           FontSize="20"
                           FontAttributes="Bold"/>
                    <Button Text="âœ–"
                            FontSize="20"
                            BackgroundColor="Transparent"
                            HorizontalOptions="End"
                            Command="{Binding ToggleMenuCommand}"/>
                </Grid>

                <!-- Opciones del menÃº -->
                <VerticalStackLayout Spacing="5" Padding="10">

                    <Button Text="     Descargar contraseÃ±as     "
                            Command="{Binding DownloadPasswordsCommand}"
                            HorizontalOptions="Fill"
                            ImageSource="icon_download_512.png"
                            HeightRequest="50"
                            Margin="0,5"/>

                    <Button Text="         Desencriptar todas         "
                            Command="{Binding DecryptAllCommand}"
                            HorizontalOptions="Fill"
                            ImageSource="icon_eye_lock_open_512.png"
                            HeightRequest="50"
                            Margin="0,5"/>
                    
                    <Button Text="     Crear nueva contraseÃ±a     "
                            Command="{Binding CreatePasswordCommand}"
                            HorizontalOptions="Fill"
                            ImageSource="icon_book_512.png"
                            HeightRequest="50"
                            Margin="0,5"/>

                    <Button Text="Nueva clave de encriptaciÃ³n"
                            Command="{Binding NewEncryptionKeyCommand}"
                            HorizontalOptions="Fill"
                            ImageSource="icon_key_512.png"
                            HeightRequest="50"
                            Margin="0,5"/>

                    <Button Text="TEST"
                            Command="{Binding DeletePasswordCommand}"
                            HorizontalOptions="Fill"
                            Margin="0,5"/>
                </VerticalStackLayout>

            </VerticalStackLayout>

        </Border>

        <!-- Overlay oscuro cuando el menÃº estÃ¡ abierto -->
        <BoxView Grid.Row="0"
                 Grid.RowSpan="2"
                 IsVisible="{Binding IsMenuOpen}"
                 BackgroundColor="#80000000"
                 ZIndex="99">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleMenuCommand}"/>
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- BotÃ³n flotante para crear nueva contraseÃ±a -->
        <Border Grid.Row="1"
               WidthRequest="60"
               HeightRequest="60"
               StrokeShape="RoundRectangle 30"
               BackgroundColor="#2196F3"
               VerticalOptions="End"
               HorizontalOptions="End"
               Margin="20"
               ZIndex="50">
            <Button Text="+"
                    FontSize="30"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    Command="{Binding CreatePasswordCommand}"/>
        </Border>

    </Grid>

</ContentPage>